---
title: "Song songdata"
author: "Silvia Ventoruzzo"
date: "10/5/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preparation

Packages & functions
```{r}
library(tidyverse)
library(tidytext)
library(DataExplorer)
library(gridExtra)
library(tm)
library(topicmodels)
library(gtools)
library(gtable)
library(quanteda)
library(stopwords)
library(reshape2)
library(cld3)
```

Load dataset
```{r}
songs_genre <- read_csv("./Data/lyrics.csv.zip")
songs       <- read_csv("./Data/songdata.csv.zip")
```

Join datasets
```{r}
# Clean before joining
songs_genre <- songs_genre %>%
  select(-index, -lyrics) %>%
  mutate(song   = gsub("-", " ", song),
         artist = gsub("-", " ", artist),
         artist = ifelse(artist == "beyonce knowles", "beyonce", artist)) %>%
  filter(genre != "Not Available") %>%
  mutate_if(is.character, tolower)

songs <- songs %>%
  select(-link) %>%
  filter(!is.na(text)) %>%
  mutate_if(!(grepl("text", names(.))), tolower)

# Join
songdata <- songs %>%
  inner_join(songs_genre, by = c("artist", "song"))

rm("songs_genre", "songs")
```

We would like to keep only 200 songs, but at the moment we have 11555. We initially look at the language, restricting our dataset of only songs in English, and length of the song, keeping only songs with length bigger than 1st quantile.
```{r}
# Language
songdata <- songdata %>%
  mutate(text_language = detect_language(text))

songdata %>%
  count(text_language) %>%
  mutate(text_language = reorder(text_language, -n)) %>%
  ggplot() +
  geom_bar(aes(x = text_language, y = n), stat = "identity")

songdata <- songdata %>%
  filter(text_language == "en") %>%
  select(-text_language)

# Length
songdata <- songdata %>%
  mutate(text_length = str_length(songdata$text))

songdata %>%
  ggplot() +
  geom_boxplot(aes(x = factor(0), y = text_length)) +
  coord_flip()

songdata <- songdata %>%
  filter(text_length > quantile(text_length, 0.25)) %>%
  select(-text_length)
```

We now look at the distributions of the variables artist, year and genre.
```{r}
# Year
songdata %>%
  count(year) %>%
  mutate(occurences = n/sum(n)) %>%
  ggplot() +
  geom_bar(aes(x = year, y = occurences), stat = "identity") +
  scale_x_continuous(breaks = seq(min(songdata$year), max(songdata$year), 5)) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title    = "Distribution of song years",
       subtitle = "Initial data")

# Genre
songdata %>%
  count(genre) %>%
  mutate(occurences = n/sum(n)) %>%
  ggplot() +
  geom_bar(aes(x = reorder(genre, -occurences), y = occurences), stat = "identity") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x        = "genre",
       title    = "Distribution of music genres",
       subtitle = "Initial data")

# Artist
songdata %>%
  count(artist) %>%
  mutate(occurences = n/sum(n)) %>%
  ggplot() +
  geom_bar(aes(x = reorder(artist, occurences), y = occurences), stat = "identity") +
  scale_y_continuous(labels = scales::percent_format()) +
  coord_flip() +
  labs(x        = "artist",
       title    = "Distribution of artists",
       subtitle = "Initial data")
```

We can see that great part of the songs are from 2005 onwards. We will therefore firstly restrict the dataset to the songs from 2010. We will furthermore only keep songs of the 5 most common music genres (pop, rock, hip-hop, jazz, country).
```{r}
songdata <- songdata %>%
  filter(year >= 2010,
         genre %in% c("pop", "rock", "hip-hop", "jazz", "country"))
```

We still have too many songs (1483). We will thus now look at artists. We wish to create some variability in the texts, therefore it would be good to have a mixture of different artists. I would however prefer having famous artists, to make the project more relatable, but also considering a mix of genres. Following artists will be kept:
- adele
- aerosmith
- avril lavigne
- backstreet boys
- billie holiday
- bon jovi
- coldplay
- depeche mode
- dolly parton
- drake
- ed sheeran
- ella fitzgerald
- eminem
- enrique iglesias
- evanescence
- foo fighters
- fall out boy
- george jones
```{r}
set.seed(62781649)
songdata <- songdata %>%
  filter(artist %in% c("adele", "aerosmith", "avril lavigne", "backstreet boys", "billie holiday", "bon jovi", "coldplay", "depeche mode", "dolly parton", "drake", "ed sheeran", "ella fitzgerald", "eminem", "evanescence", "foo fighters", "fall out boy", "george jones")) %>%
  sample_n(200)
```

Produce now final plots
```{r}
distribution_plots <- list()
distribution_plots[["artist"]] <- songdata %>%
  count(artist) %>%
  mutate(occurences = n/sum(n)) %>%
  ggplot() +
  geom_bar(aes(x = reorder(artist, occurences), y = occurences), stat = "identity", fill = "chartreuse4") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme(axis.title.y = element_text(size = 12),
        axis.text.y  = element_text(size = 7),
        axis.title.x = element_blank()) +
  labs(x = "artist") +
  coord_flip()
distribution_plots[["genre"]] <- songdata %>%
  count(genre) %>%
  mutate(occurences = n/sum(n)) %>%
  ggplot() +
  geom_bar(aes(x = reorder(genre, occurences), y = occurences), stat = "identity", fill = "chartreuse4") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme(axis.title.y = element_text(size = 12),
        axis.title.x = element_blank()) +
  labs(x = "genre") +
  coord_flip()
distribution_plots[["year"]] <- songdata %>%
  count(year) %>%
  mutate(occurences = n/sum(n)) %>%
  ggplot() +
  geom_bar(aes(x = year, y = occurences), stat = "identity", fill = "chartreuse4") +
  scale_x_continuous(breaks = seq(min(songdata$year), max(songdata$year), 1),
                     trans  = "reverse") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme(axis.title.y = element_text(size = 12),
        axis.title.x = element_blank()) +
  coord_flip()
grid.newpage()
grid.draw(rbind(ggplotGrob(distribution_plots[["artist"]]), ggplotGrob(distribution_plots[["genre"]]), ggplotGrob(distribution_plots[["year"]]), size = "first"))
rm(distribution_plots)
```

Look at summed percentages
```{r}
# Artist
songdata %>%
  count(artist) %>%
  arrange(-n) %>%
  mutate(perc = n/sum(n), 
         cumsum = cumsum(perc))

# Genre
songdata %>%
  count(genre) %>%
  arrange(n) %>%
  mutate(perc = n/sum(n), 
         cumsum = cumsum(perc))
```

Combination artist-genre
Each artist is associated to only one genre
```{r}
songdata %>%
  count(artist, genre) %>%
  count(artist)
```

Text length
```{r}
songdata %>%
  mutate(text_length = str_length(songdata$text)) %>%
  ggplot() +
  geom_boxplot(aes(x = factor(0), y = text_length), fill = "chartreuse4") +
  theme(axis.title.y = element_blank(),
        axis.text.y  = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = 12)) +
  labs(y = "text length") +      
  coord_flip() +
  facet_wrap(~genre)

```

text
```{r}
# songdata <- songdata %>%
#   mutate(text = tolower(text),
#          text = removePunctuation(text),
#          text = removeNumbers(text),
#          text = stripWhitespace(text),
#          text = stemDocument(text))
```

genre - year
```{r}
songdata %>%
  count(year, genre) %>%
  group_by(year) %>%
  mutate(percentage = n/sum(n)) %>%
  ungroup() %>%
  ggplot() +
  geom_line(aes(x = year, y = percentage, color = genre))

# From: https://towardsdatascience.com/text-analytics-topic-modelling-on-music-genres-song-songdata-deb82c86caa2
songdata %>% 
  mutate(fiveyears = as.character(year) %>%
                      paste("01", "01", sep = "-") %>%
                      as.Date() %>%
                      lubridate::floor_date("y year")) %>%
  count(fiveyears, genre) %>% 
  group_by(fiveyears) %>%
  mutate(freq = round(n/sum(n), 2)) %>% 
  # filter(genre %in% c("Country", "Hip-Hop", "Metal", "Pop", "Rock")) %>% 
  ggplot(aes(fiveyears, freq, colour = genre)) +
  # geom_line() +
  geom_smooth(se = FALSE) +
  labs(x = "year", y = "smoothed")+
  scale_y_continuous(labels = scales::percent_format()) 
```




# Data preparation

Tokenization
```{r}
songdata_words <- songdata %>%
  unnest_tokens(output = "word", input = "text", token = "words")
```

Remove stop words
```{r}
# custom_stopwords <- stop_words %>%
#   rbind(data.frame(word    = c("1", "na", "uh", "ooh", "an"),
#                    lexicon = rep("custom", 5)))
# 
# songdata_words <- songdata_words %>%
#   anti_join(custom_stopwords, by = "word")
# Think about if adding custom stop words
```

Transform into DocumentTermMatrix
```{r}
# songdata_dtm <- songdata_words %>%
#   count(artist, song, word, sort = TRUE) %>%
#   ungroup() %>%
#   cast_dtm(term = "word", document = "song", value = "n")

stopwords <- lapply(stopwords_getsources()[stopwords_getsources() != "misc"], 
                    function(x) stopwords::stopwords(language = "en", source = x)) %>%
  unlist()

songdata_tokens <- songdata %>%
  corpus() %>%
  tokens(what = "word",
         remove_numbers = TRUE, remove_punct = TRUE,
         remove_symbols = TRUE, remove_separators = TRUE)

docnames(songdata_tokens) <- paste(songdata$artist, songdata$song, sep = ";")

songdata_dtm <- songdata_tokens %>%
  dfm(tolower = TRUE, stem = TRUE, remove = stopwords)

rm("stopwords", "songdata_tokens")
```

Perform Latent Dirichlet Allocation
```{r}
songdata_lda <- LDA(songdata_dtm, k = 5, control = list(seed = 978324))
```

Calculate probabilites of interest:
- beta = per-topic-per-word probabilities
- lambda = per-document-per-topic probabilities
```{r}
songdata_beta <- tidy(songdata_lda, matrix = "beta")
songdata_gamma <- tidy(songdata_lda, matrix = "gamma")
```

Words in topics
```{r}
songdata_beta %>%
  group_by(topic) %>%
  top_n(10, beta) %>%
  ungroup() %>%
  arrange(topic, -beta) %>%
  mutate(term  = reorder(term, beta),
         topic = paste0("topic", topic)) %>%
  ggplot(aes(term, beta, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  coord_flip()
```

Gamma for genres (= documents)
```{r}
genre_gamma <- songdata_gamma %>%
  separate(document, into = c("artist", "song"), sep = ";") %>%
  inner_join(songdata, by = c("artist", "song")) %>%
  select(-year, -text)

genre_gamma %>%
  mutate(genre = reorder(genre, gamma * topic)) %>%
  ggplot(aes(factor(topic), gamma, colour = factor(topic))) +
  geom_boxplot(alpha = 0.7) +
  labs(y = "Probability", x = "Topic", 
       title = "Topic probabilities per music genre", 
       subtitle = "") +
  labs(col="Topics",
       y = "Probabilities") +
  facet_wrap(~ genre)


genre_gamma %>%
  mutate(genre = reorder(genre, gamma * topic)) %>%
  ggplot(aes(x = gamma, colour = factor(topic))) +
  geom_line(stat = "count") +
  labs(y = "Probability", x = "Topic", 
       title = "Topic probabilities per music genre", 
       subtitle = "") +
  labs(col="Topics",
       y = "Probabilities") +
  facet_wrap(~genre)
```